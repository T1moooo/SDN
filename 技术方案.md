# SDN QoS 策略管理系统 - MVP 技术方案

**版本**: MVP v1.0  
**日期**: 2025-10-15  
**目标**: 通过声明式策略自动化管理校园网 QoS，确保关键应用（选课系统）获得高优先级

---

## 一、项目目标

### 核心问题
校园网中选课系统等关键应用与视频流、P2P 下载竞争带宽，导致业务响应慢、用户体验差。

### 解决方案
基于 Cisco Nexus 9000v NX-API 开发**声明式 QoS 策略管理系统**：
- 管理员用 YAML 描述策略（关键应用优先级）
- 系统自动翻译为设备配置并下发
- 提供 Web UI 可视化管理

### MVP 范围
| 功能 | 描述 |
|------|------|
| ✅ 策略上传 | 通过 Web UI 上传 YAML 策略文件 |
| ✅ 策略解析 | 解析 YAML 并生成 NX-CLI 命令 |
| ✅ Dry-run | 预览命令不执行 |
| ✅ 配置下发 | 通过 NX-API 批量下发配置 |
| ✅ 状态查看 | Web UI 显示策略列表与执行状态 |
| ✅ 日志记录 | 记录所有操作到文件 |
| ❌ 配置回滚 | 后续版本 |
| ❌ 多设备管理 | 后续版本 |
| ❌ 权限管理 | 后续版本 |

---

## 二、系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                       用户层                                 │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │           Web UI (前端界面)                         │     │
│  │  • 策略上传页面 (Upload Policy)                     │     │
│  │  • 策略列表页面 (Policy List)                       │     │
│  │  • 执行日志页面 (Logs)                              │     │
│  └────────────────┬───────────────────────────────────┘     │
│                   │ HTTP REST API                           │
└───────────────────┼─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                  应用服务层 (Flask 后端)                     │
│                                                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │  app.py - REST API Gateway                         │     │
│  │  ├─ POST /api/policies          上传策略           │     │
│  │  ├─ GET  /api/policies          策略列表           │     │
│  │  ├─ POST /api/policies/{id}/apply  应用策略        │     │
│  │  └─ GET  /api/logs              查询日志           │     │
│  └────────────────┬───────────────────────────────────┘     │
└───────────────────┼─────────────────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│PolicyEngine │ │  Deployer   │ │   Logger    │
│ (策略引擎)  │ │ (配置下发)  │ │  (日志)     │
└──────┬──────┘ └──────┬──────┘ └─────────────┘
       │               │
       │ YAML→CLI      │ NX-API (JSON-RPC/HTTPS)
       ▼               ▼
┌─────────────────────────────────────────────────────────────┐
│                    Cisco Nexus 9000v                         │
│                    NX-API Endpoint (/ins)                    │
└─────────────────────────────────────────────────────────────┘
```

### 模块职责

| 模块 | 文件 | 职责 |
|------|------|------|
| **前端 UI** | `frontend/` | 提供 Web 界面（HTML/CSS/JS） |
| **API 网关** | `app.py` | Flask 应用，处理 HTTP 请求 |
| **策略引擎** | `core/engine.py` | YAML 解析 + CLI 命令生成 |
| **配置下发** | `core/deployer.py` | NX-API 通信与命令下发 |
| **数据模型** | `core/models.py` | 策略数据结构定义 |
| **日志模块** | `utils/logger.py` | 日志记录与查询 |

---

## 三、目录结构（MVP）

```
SDN/
├── app.py                      # Flask 应用入口
├── config.py                   # 配置管理
├── requirements.txt            # Python 依赖
├── .env.example                # 环境变量模板
├── .gitignore                  # Git 忽略规则
│
├── core/                       # 核心业务逻辑
│   ├── __init__.py
│   ├── engine.py               # 策略引擎（解析+生成）
│   ├── deployer.py             # NX-API 客户端
│   └── models.py               # 数据模型
│
├── utils/                      # 工具模块
│   ├── __init__.py
│   └── logger.py               # 日志工具
│
├── frontend/                   # 前端界面
│   ├── index.html              # 主页（策略列表）
│   ├── upload.html             # 上传策略页面
│   ├── logs.html               # 日志查看页面
│   ├── static/
│   │   ├── css/
│   │   │   └── style.css       # 样式文件
│   │   └── js/
│   │       └── app.js          # 前端逻辑
│   └── templates/              # Jinja2 模板（可选）
│
├── policies/                   # 策略文件存储
│   ├── examples/               # 示例策略
│   │   └── course-priority.yaml
│   └── uploaded/               # 用户上传的策略
│
├── logs/                       # 日志目录
│   ├── app.log                 # 应用日志
│   └── operations/             # 操作日志（按日期）
│       └── 2025-10-15.log
│
├── tests/                      # 测试代码
│   ├── test_engine.py          # 引擎测试
│   └── test_deployer.py        # 下发测试
│
└── docs/                       # 文档
    ├── API.md                  # API 文档
    └── ARCHITECTURE.md         # 架构文档
```

---

## 四、核心模块设计

### 4.1 前端 UI (frontend/)

#### 页面设计

**1. 主页 (index.html) - 策略列表**
```
┌─────────────────────────────────────────────┐
│  SDN QoS 策略管理系统                        │
├─────────────────────────────────────────────┤
│  [上传策略] [查看日志]                       │
├─────────────────────────────────────────────┤
│  策略列表:                                   │
│  ┌─────────────────────────────────────┐    │
│  │ ID  │ 名称          │ 状态  │ 操作  │    │
│  ├─────────────────────────────────────┤    │
│  │ 001 │ course-priority│ 已应用│[详情]│    │
│  │ 002 │ video-limit   │ 待应用│[应用]│    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

**2. 上传页面 (upload.html)**
```
┌─────────────────────────────────────────────┐
│  上传 QoS 策略                               │
├─────────────────────────────────────────────┤
│  选择文件: [浏览...]  course-priority.yaml  │
│                                              │
│  [上传] [取消]                               │
├─────────────────────────────────────────────┤
│  预览:                                       │
│  ┌─────────────────────────────────────┐    │
│  │ id: course-priority-v1              │    │
│  │ name: "选课系统高优先级策略"         │    │
│  │ ...                                 │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

**3. 日志页面 (logs.html)**
```
┌─────────────────────────────────────────────┐
│  操作日志                                    │
├─────────────────────────────────────────────┤
│  [刷新] [导出]                               │
├─────────────────────────────────────────────┤
│  时间              │ 操作      │ 状态       │
│  2025-10-15 14:30 │ apply_policy│ 成功     │
│  2025-10-15 14:25 │ upload      │ 成功     │
└─────────────────────────────────────────────┘
```

#### 前端技术栈
- **HTML5** - 页面结构
- **CSS3** - 样式（可选 Bootstrap）
- **Vanilla JavaScript** - 交互逻辑（不引入复杂框架）
- **Fetch API** - 与后端通信

---

### 4.2 策略引擎 (core/engine.py)

**核心功能**:
1. 解析 YAML 策略文件
2. 验证策略语法和语义
3. 生成有序的 NX-CLI 命令列表

**示例代码结构**:
```python
class PolicyEngine:
    def parse_yaml(self, filepath: str) -> PolicyModel:
        """解析 YAML 文件"""
        pass
    
    def generate_commands(self, policy: PolicyModel) -> List[str]:
        """生成 CLI 命令"""
        # 顺序: ACL → class-map → policy-map → service-policy
        pass
    
    def validate(self, policy: PolicyModel) -> List[str]:
        """验证策略合法性"""
        pass
```

---

### 4.3 配置下发器 (core/deployer.py)

**核心功能**:
1. 封装 NX-API 通信
2. 批量下发配置命令
3. 解析设备响应

**示例代码结构**:
```python
class NXAPIClient:
    def __init__(self, host: str, username: str, password: str):
        pass
    
    def execute_commands(self, commands: List[str], 
                        dry_run: bool = False) -> dict:
        """执行命令（支持 dry-run）"""
        pass
    
    def show_command(self, cmd: str) -> dict:
        """执行 show 命令"""
        pass
```

---

### 4.4 数据模型 (core/models.py)

```python
from dataclasses import dataclass
from typing import List

@dataclass
class PolicyModel:
    """策略数据模型"""
    id: str
    name: str
    description: str
    acls: List[dict]
    class_maps: List[dict]
    policy_maps: List[dict]
    service_policies: List[dict]

@dataclass
class ExecutionResult:
    """执行结果"""
    success: bool
    message: str
    commands: List[str]
    errors: List[str] = None
```

---

## 五、API 接口设计

### REST API 端点

| 方法 | 路径 | 功能 | 请求体 | 响应 |
|------|------|------|--------|------|
| GET | `/` | 主页 | - | HTML |
| GET | `/upload` | 上传页面 | - | HTML |
| GET | `/logs` | 日志页面 | - | HTML |
| POST | `/api/policies` | 上传策略 | `multipart/form-data` | `{id, status}` |
| GET | `/api/policies` | 策略列表 | - | `{policies: [...]}` |
| POST | `/api/policies/{id}/apply` | 应用策略 | `{dry_run: bool}` | `{success, result}` |
| GET | `/api/logs` | 查询日志 | - | `{logs: [...]}` |

### 请求/响应示例

**上传策略**:
```bash
POST /api/policies
Content-Type: multipart/form-data

file: course-priority.yaml
```

响应:
```json
{
  "success": true,
  "policy_id": "course-priority-v1",
  "message": "策略上传成功"
}
```

**应用策略**:
```bash
POST /api/policies/course-priority-v1/apply
Content-Type: application/json

{
  "dry_run": false
}
```

响应:
```json
{
  "success": true,
  "message": "策略应用成功",
  "details": {
    "commands_executed": 12,
    "duration_ms": 3456
  }
}
```

---

## 六、策略文件格式（YAML）

### 示例策略文件

```yaml
# policies/examples/course-priority.yaml
---
id: course-priority-v1
name: "选课系统高优先级策略"
description: "确保选课系统流量获得最高优先级"

# 定义 ACL
access_lists:
  - name: ACL_COURSE_SELECTION
    type: ipv4
    rules:
      - sequence: 10
        action: permit
        protocol: tcp
        source: 10.100.0.0/16      # 选课系统服务器
        destination: any
        dest_port: [80, 443]

# 定义流分类
class_maps:
  - name: CLASS_CRITICAL_APPS
    match_type: match-any
    conditions:
      - type: access-group
        name: ACL_COURSE_SELECTION

# 定义策略映射
policy_maps:
  - name: PM_CAMPUS_QOS
    classes:
      - class_name: CLASS_CRITICAL_APPS
        actions:
          - type: set
            parameter: dscp
            value: ef              # 最高优先级

# 应用到接口
service_policies:
  - interface: Ethernet1/1
    direction: input
    policy_map: PM_CAMPUS_QOS
```

### CLI 转换结果

系统自动生成以下命令:
```cisco
ip access-list ACL_COURSE_SELECTION
  10 permit tcp 10.100.0.0/16 any eq 80
  20 permit tcp 10.100.0.0/16 any eq 443

class-map match-any CLASS_CRITICAL_APPS
  match access-group name ACL_COURSE_SELECTION

policy-map PM_CAMPUS_QOS
  class CLASS_CRITICAL_APPS
    set dscp ef

interface Ethernet1/1
  service-policy input PM_CAMPUS_QOS
```

---

## 七、实现计划（MVP）

### 阶段 1: 基础框架（3 天）
- [ ] 创建目录结构
- [ ] 配置开发环境
- [ ] 实现数据模型 (`core/models.py`)
- [ ] 搭建 Flask 应用框架

### 阶段 2: 核心功能（5 天）
- [ ] 实现策略引擎 (`core/engine.py`)
  - YAML 解析
  - CLI 命令生成
  - 策略验证
- [ ] 实现配置下发 (`core/deployer.py`)
  - NX-API 通信
  - Dry-run 模式
  - 错误处理

### 阶段 3: Web UI（4 天）
- [ ] 设计页面布局（HTML/CSS）
- [ ] 实现前端交互（JavaScript）
- [ ] 集成后端 API

### 阶段 4: 测试与优化（3 天）
- [ ] 单元测试
- [ ] 集成测试（DevNet Sandbox）
- [ ] 日志与错误处理完善

**总计**: 15 天（3 周）

---

## 八、技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| 前端 | HTML5 + CSS3 + JS | Web 界面 |
| 后端 | Flask (Python 3.9+) | REST API 服务器 |
| 配置 | YAML | 策略描述 |
| 通信 | NX-API (JSON-RPC/HTTPS) | 设备配置 |
| 测试 | pytest | 单元测试 |
| 部署 | DevNet Sandbox / 本地 VM | 测试环境 |

---

## 九、快速开始

### 1. 环境准备
```bash
# 克隆项目
git clone <repo_url>
cd SDN

# 创建虚拟环境
python -m venv .venv
.venv\Scripts\Activate.ps1  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置环境变量
```bash
# 复制配置模板
cp .env.example .env

# 编辑 .env 填入设备信息
SWITCH_IP=192.168.1.1
SWITCH_USERNAME=admin
SWITCH_PASSWORD=your_password
```

### 3. 启动应用
```bash
python app.py
```

访问: `http://localhost:5000`

### 4. 上传策略
1. 打开浏览器访问 `http://localhost:5000/upload`
2. 选择策略文件（如 `policies/examples/course-priority.yaml`）
3. 点击"上传"
4. 返回主页查看策略列表
5. 点击"应用"下发配置

---

## 十、验收标准

### 功能验收
- ✅ 能通过 Web UI 上传策略文件
- ✅ 能在页面查看策略列表
- ✅ 能执行 dry-run 预览命令
- ✅ 能成功下发配置到设备
- ✅ 能在日志页面查看操作记录

### 测试用例
1. 上传合法策略 → 成功
2. 上传非法策略 → 显示错误信息
3. Dry-run 模式 → 返回命令预览
4. 应用策略 → 设备配置生效
5. 查看日志 → 显示历史操作

---

## 附录

### A. 依赖包 (requirements.txt)
```
Flask==3.0.0
PyYAML==6.0.1
requests==2.31.0
python-dotenv==1.0.0
```

### B. 环境变量 (.env.example)
```
SWITCH_IP=192.168.1.1
SWITCH_USERNAME=admin
SWITCH_PASSWORD=your_password
FLASK_PORT=5000
DRY_RUN=false
```

### C. 示例命令
```bash
# 测试连接
curl http://localhost:5000/api/policies

# 上传策略
curl -X POST -F "file=@policies/examples/course-priority.yaml" \
  http://localhost:5000/api/policies

# 应用策略（dry-run）
curl -X POST -H "Content-Type: application/json" \
  -d '{"dry_run": true}' \
  http://localhost:5000/api/policies/course-priority-v1/apply
```

---

**MVP 版本交付**: 3 周后可完成基础功能，后续迭代添加高级特性。
